<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapFish Print</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .url-box { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; word-break: break-all; margin: 10px 0; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è MapFish Print</h1>

    <h3>Choose Layout:</h3>
    <button onclick="createPrintJob('A4 portrait')">üìÑ A4 Portrait</button>
    <button onclick="createPrintJob('A4 landscape')">üìÑ A4 Landscape</button>
    <button onclick="createPrintJob('A4 simple')">üìÑ A4 Simple</button>
    <button onclick="createGAWMTSPrintJob()">üåç GA WMTS</button>

    <div id="status"></div>
    <div id="urls"></div>

    <script>
        const BASE_URL = 'http://localhost:18083';
        const APP_NAME = 'default';

        function getRequestData(layout) {
            const baseData = {
                "attributes": {
                    "map": {
                        "bbox": [87741.27046802844, 5468479.575967243, 1090000.7295319715, 5892512.424032757],
                        "dpi": 200,
                        "layers": [{
                            "baseURL": "https://ows.terrestris.de/osm/service?",
                            "customParams": {"LAYERS": "OSM-WMS", "STYLES": "", "TRANSPARENT": true, "VERSION": "1.1.1"},
                            "tileSize": [512, 512],
                            "layers": ["OSM-WMS"],
                            "opacity": 1,
                            "styles": [""],
                            "type": "tiledwms"
                        }],
                        "projection": "EPSG:25832",
                        "rotation": 0
                    }
                },
                "layout": layout
            };

            // Add legend only for portrait and landscape (not simple)
            if (layout !== 'A4 simple') {
                baseData.attributes.legend = {
                    "name": "",
                    "classes": [{
                        "name": "OSM-WMS",
                        "icons": ["https://ows.terrestris.de/osm/service?SERVICE=WMS&REQUEST=GetLegendGraphic&VERSION=1.3.0&LAYER=OSM-WMS&FORMAT=image/png"]
                    }]
                };
            }

            return baseData;
        }

        function showStatus(message, type = 'info') {
            document.getElementById('status').innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function createPrintJob(layout) {
            showStatus(`üöÄ Creating ${layout} print job...`, 'info');

            try {
                const requestData = getRequestData(layout);
                const response = await fetch(`${BASE_URL}/print/${APP_NAME}/report.pdf`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                const jobRef = result.ref;

                if (jobRef) {
                    const downloadUrl = `${BASE_URL}/print/${APP_NAME}/report/${jobRef}`;

                    showStatus(`‚úÖ ${layout} print job created!`, 'success');
                    document.getElementById('urls').innerHTML = `
                        <p><strong>Layout:</strong> ${layout}</p>
                        <p><strong>Download URL:</strong></p>
                        <div class="url-box">${downloadUrl}</div>
                        <button onclick="window.open('${downloadUrl}', '_blank')">üì• Download PDF</button>
                    `;
                } else {
                    showStatus('‚ùå No job reference received', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function extractWMTSParameters(doc, matrixSetId = 'DE_EPSG_3857_ADV') {
            console.log('üîç Starting parameter extraction...');
            console.log('üîç Document root element:', doc.documentElement.tagName);

            // Get layer info - try different selectors
            let layerElement = doc.querySelector('Layer ows\\:Identifier') ||
                              doc.querySelector('Layer Identifier') ||
                              doc.querySelector('ows\\:Identifier');

            if (!layerElement) {
                console.error('‚ùå Could not find layer identifier');
                throw new Error('Layer identifier not found in capabilities');
            }
            const layer = layerElement.textContent;
            console.log('üîç Layer:', layer);

            // Get ResourceURL template
            const resourceURLElement = doc.querySelector('ResourceURL[resourceType="tile"]');
            if (!resourceURLElement) {
                console.error('‚ùå Could not find ResourceURL element');
                throw new Error('ResourceURL not found in capabilities');
            }
            const resourceURL = resourceURLElement.getAttribute('template');
            console.log('üîç ResourceURL template:', resourceURL);

            // Get available formats
            const formatElements = doc.querySelectorAll('Layer Format');
            const formats = Array.from(formatElements).map(f => f.textContent);
            console.log('üîç Available formats:', formats);

            // Get available matrix sets
            const matrixSetElements = doc.querySelectorAll('TileMatrixSetLink TileMatrixSet');
            const matrixSets = Array.from(matrixSetElements).map(ms => ms.textContent);
            console.log('üîç Available matrix sets:', matrixSets);

            // Get style
            const styleElement = doc.querySelector('Style ows\\:Identifier') ||
                                doc.querySelector('Style Identifier');
            if (!styleElement) {
                console.error('‚ùå Could not find style identifier');
                throw new Error('Style identifier not found in capabilities');
            }
            const style = styleElement.textContent;
            console.log('üîç Style:', style);

            // Get matrix definitions for specified matrix set
            const matrixSetElements = doc.querySelectorAll('TileMatrixSet');
            console.log('üîç Found', matrixSetElements.length, 'TileMatrixSet elements');

            const matrixSetElement = Array.from(matrixSetElements).find(ms => {
                const idElement = ms.querySelector('ows\\:Identifier') || ms.querySelector('Identifier');
                return idElement && idElement.textContent === matrixSetId;
            });

            if (!matrixSetElement) {
                console.error('‚ùå Matrix set not found:', matrixSetId);
                console.log('üîç Available matrix sets in document:',
                    Array.from(matrixSetElements).map(ms => {
                        const idEl = ms.querySelector('ows\\:Identifier') || ms.querySelector('Identifier');
                        return idEl ? idEl.textContent : 'NO_ID';
                    })
                );
                throw new Error(`Matrix set ${matrixSetId} not found in capabilities`);
            }

            const tileMatrixElements = matrixSetElement.querySelectorAll('TileMatrix');
            console.log('üîç Found', tileMatrixElements.length, 'TileMatrix elements');

            const matrices = Array.from(tileMatrixElements).map(tm => {
                const idElement = tm.querySelector('ows\\:Identifier') || tm.querySelector('Identifier');
                const scaleElement = tm.querySelector('ScaleDenominator');
                const cornerElement = tm.querySelector('TopLeftCorner');
                const widthElement = tm.querySelector('TileWidth');
                const heightElement = tm.querySelector('TileHeight');
                const matrixWidthElement = tm.querySelector('MatrixWidth');
                const matrixHeightElement = tm.querySelector('MatrixHeight');

                return {
                    identifier: idElement ? idElement.textContent : 'UNKNOWN',
                    scaleDenominator: scaleElement ? parseFloat(scaleElement.textContent) : 0,
                    topLeftCorner: cornerElement ? cornerElement.textContent.split(' ').map(Number) : [0, 0],
                    tileSize: [
                        widthElement ? parseInt(widthElement.textContent) : 256,
                        heightElement ? parseInt(heightElement.textContent) : 256
                    ],
                    matrixSize: [
                        matrixWidthElement ? parseInt(matrixWidthElement.textContent) : 1,
                        matrixHeightElement ? parseInt(matrixHeightElement.textContent) : 1
                    ]
                };
            });

            console.log('üîç Matrices for', matrixSetId, ':', matrices);

            return {
                baseURL: resourceURL,
                layer: layer,
                matrixSet: matrixSetId,
                imageFormat: formats[0], // Use first available format
                style: style,
                matrices: matrices,
                availableMatrixSets: matrixSets,
                availableFormats: formats
            };
        }

        async function parseWMTSCapabilities(matrixSetId = 'DE_EPSG_3857_ADV') {
            try {
                const response = await fetch('https://sgx.geodatenzentrum.de/wmts_basemapde/1.0.0/WMTSCapabilities.xml');
                const capabilitiesText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(capabilitiesText, 'text/xml');

                return extractWMTSParameters(doc, matrixSetId);

            } catch (error) {
                console.error('‚ùå Error parsing capabilities:', error);
                return null;
            }
        }

        async function createGAWMTSPrintJob() {
            showStatus(`üöÄ Creating GA WMTS print job...`, 'info');

            try {
                // Parse capabilities to get WMTS parameters
                const wmtsConfig = await parseWMTSCapabilities();
                if (!wmtsConfig) {
                    throw new Error('Failed to parse WMTS capabilities');
                }

                console.log('üîß Generated WMTS config:', wmtsConfig);
                const requestData = {
                    "attributes": {
                        "map": {

                            "center": [894000, 6598000],
                            "scale": 25000,
                            "dpi": 200,
                            "layers": [{
                                "baseURL": wmtsConfig.baseURL,
                                "customParams": {"LAYERS": wmtsConfig.layer, "STYLES": wmtsConfig.style, "TRANSPARENT": true, "VERSION": "1.0.0"},
                                "layer": wmtsConfig.layer,
                                "matrixSet": wmtsConfig.matrixSet,
                                "imageFormat": wmtsConfig.imageFormat,
                                "style": wmtsConfig.style,
                                "requestEncoding": "REST",
                                "type": "wmts",
                                "matrices": wmtsConfig.matrices
                            }],
                            "projection": "EPSG:3857",
                            "rotation": 0
                        }
                    },
                    "layout": "A4 simple"
                };

                console.log('üìã Final request data:', JSON.stringify(requestData, null, 2));

                const response = await fetch(`${BASE_URL}/print/${APP_NAME}/report.pdf`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                const jobRef = result.ref;

                if (jobRef) {
                    const downloadUrl = `${BASE_URL}/print/${APP_NAME}/report/${jobRef}`;

                    showStatus(`‚úÖ GA WMTS print job created!`, 'success');
                    document.getElementById('urls').innerHTML = `
                        <p><strong>Layout:</strong> A4 Simple (GA WMTS)</p>
                        <p><strong>Layer:</strong> de_basemapde_web_raster_farbe</p>
                        <p><strong>Matrix Set:</strong> DE_EPSG_3857_ADV</p>
                        <p><strong>Download URL:</strong></p>
                        <div class="url-box">${downloadUrl}</div>
                        <button onclick="window.open('${downloadUrl}', '_blank')">üì• Download PDF</button>
                    `;
                } else {
                    showStatus('‚ùå No job reference received', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
